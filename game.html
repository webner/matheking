<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="index.css">
        <title>Matheking</title>
    </head>

    <body>
        <div class="title">Matheking</div>

        <div class="counter">Frage 1:</div>
        <div class="question">5*6=?</div>
        <div class="answers">
            <button class="answer">10</button>
        </div>
    </body>

    <script>
        const params = new URLSearchParams(window.location.search);
        const name = params.get('player');
        const g = params.get('g');
        const startTime = new Date();

        function ascending(a, b) { return a-b; }

        function shuffle(array) {
            let currentIndex = array.length;

            // While there remain elements to shuffle...
            while (currentIndex != 0) {

                // Pick a remaining element...
                let randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;

                // And swap it with the current element.
                [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
            }
        }

        function mulTests() {
            let tests = []
            for (a = 2; a <= 10; a++) {
                for (b = 2; b <= 10; b++) {
                    tests.push({"question": a + " * " + b + " =", answer: a*b});
                }
            }
            return tests;
        }

        function divTests() {
            let tests = []
            for (a = 2; a <= 10; a++) {
                for (b = 2; b <= 10; b++) {
                    tests.push({"question": (a*b) + " / " + b + " =", answer: a});
                }
            }
            return tests;
        }

        tests = g == "mul" ? mulTests() : divTests();
        uniq_answers = Array.from(new Set(tests.map(t => t.answer))).sort(ascending);
        shuffle(tests);

        questionNr = 0
        correctQuestions = 0;
        totalQuestions = 10;

        function nextTest() {
            if (questionNr == totalQuestions) {
                const endTime = new Date();
                const elapsedTime = endTime - startTime;
                document.location = "result.html?player=" + name + "&c="+correctQuestions+"&t="+totalQuestions+"&elapsed="+elapsedTime;
                return;
            }
            questionNr += 1;
            const counter = document.querySelector('div.counter');
            counter.innerHTML = "Frage " + questionNr;


            const test = tests[(questionNr-1)%tests.length]

            const q = document.querySelector('div.question');
            q.innerHTML = test.question;

            const answers = document.querySelector('div.answers');
            answersHtml = "";
            choices = new Set();
            
            // Add correct answer
            choices.add(test.answer);
            correctAnswer = test.answer;

            while (choices.size < 3) {
                j = Math.floor(Math.random() * uniq_answers.length)
                a = uniq_answers[j]
                if (!choices.has(a)) {
                    choices.add(a);
                }
            }

            choices = Array.from(choices).sort(ascending)

            for (i = 0; i < choices.length; i++) {
                answersHtml += "<button class=\"answer\" onclick=\"validateAnswer(event);\">" + choices[i] +"</button>";
            }
            answers.innerHTML = answersHtml;
        }

        function validateAnswer(event) {
            const userAnswer = parseInt(event.target.textContent);

            const buttons = document.querySelectorAll('button.answer');
            // disable all buttons
            buttons.forEach(b => b.disabled = true);

            if (userAnswer == correctAnswer) {
                correctQuestions += 1;
                event.target.classList.add("correct");
                setTimeout(nextTest, 100);
            } else {
                event.target.classList.add("wrong");
                setTimeout(nextTest, 2000);
            }

        }

        nextTest();
    </script>
</html>